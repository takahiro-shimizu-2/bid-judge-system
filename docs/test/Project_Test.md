# 入札公告要件判定システム - テスト仕様書

## 関連ドキュメント
- **設計書**: `/docs/design/Project_design.md`
- **要件定義書**: `/docs/requirements/要件定義書.md`
- **TODO リスト**: `/docs/todo/Project_TODO.md`
- **テストケース表**: `/docs/test/Project_TestCase.md`
- **テスト実装TODO**: `/docs/test/Project_Test_TODO.md`

---

## 1. テスト概要

### 1.1 テスト目的
入札公告要件判定システムが要件定義書に記載された機能を正しく実装し、期待される品質基準を満たすことを確認する。

### 1.2 テスト範囲
- サーバー側ライブラリのすべての公開関数
- クライアント側のワークフロー制御
- 外部連携（OCR/LLM）の動作確認
- タイムアウト処理と再開機能
- エラーハンドリング

### 1.3 テスト対象外
- Google Apps Script プラットフォーム自体の動作
- 外部OCR/LLMサービスの精度
- スプレッドシートUIの標準機能

---

## 2. テスト戦略

### 2.1 テストレベル
1. **単体テスト**: 各モジュールの個別機能確認
2. **結合テスト**: モジュール間連携の確認
3. **システムテスト**: エンドツーエンドの動作確認
4. **受入テスト**: ユーザー視点での妥当性確認

### 2.2 テスト手法
- **正常系テスト**: 期待される入力での動作確認
- **異常系テスト**: 不正な入力やエラー状態での動作確認
- **境界値テスト**: 制限値付近での動作確認
- **性能テスト**: 大量データでの処理時間確認

### 2.3 テスト環境
- **開発環境**: テスト用スプレッドシート（本番マスターのコピー）
- **本番環境**: 限定的な動作確認のみ

---

## 3. 単体テスト仕様

### 3.1 共通モジュール

#### 3.1.1 Utils.gs
**テスト対象関数**: `convertToHalfWidth()`
- **T-UT-001**: 全角英数字を半角に変換
  - 入力: "ＡＢＣ１２３"
  - 期待値: "ABC123"
- **T-UT-002**: 全角スペースを半角に変換
  - 入力: "　"
  - 期待値: " "
- **T-UT-003**: 混在文字列の変換
  - 入力: "Ａ1　あいう"
  - 期待値: "A1 あいう"

**テスト対象関数**: `parseDate()`
- **T-UT-004**: 標準形式（YYYY/MM/DD）
  - 入力: "2025/01/15"
  - 期待値: Date(2025, 0, 15)
- **T-UT-005**: 全角数字形式
  - 入力: "２０２５年１月１５日"
  - 期待値: Date(2025, 0, 15)
- **T-UT-006**: 和暦形式
  - 入力: "令和7年1月15日"
  - 期待値: Date(2025, 0, 15)
- **T-UT-007**: 月日のみ（今年とみなす）
  - 入力: "1月15日"
  - 期待値: Date(現在年, 0, 15)
- **T-UT-008**: 不正な日付
  - 入力: "2025/13/32"
  - 期待値: null

#### 3.1.2 Logger.gs
**テスト対象関数**: `log()`
- **T-UT-009**: 通常ログの記録
  - 入力: "処理開始", "INFO"
  - 期待値: ログシートに記録される
- **T-UT-010**: エラーログの記録
  - 入力: "エラー発生", "ERROR", {詳細: "詳細情報"}
  - 期待値: ログシートにエラー情報が記録される

### 3.2 データアクセス層

#### 3.2.1 MasterDataAccess.gs
**テスト対象関数**: `getCompanyById()`
- **T-UT-011**: 存在する企業IDでの検索
  - 入力: "C00001"
  - 期待値: 企業情報オブジェクト
- **T-UT-012**: 存在しない企業IDでの検索
  - 入力: "C99999"
  - 期待値: null
- **T-UT-013**: 無効な企業ID形式
  - 入力: ""
  - 期待値: エラー

**テスト対象関数**: `checkDisqualification()`
- **T-UT-014**: 欠格フラグなしの企業
  - 入力: {全フラグがFALSEの企業データ}
  - 期待値: {qualified: true, reasons: []}
- **T-UT-015**: 破産フラグありの企業
  - 入力: {bankruptcy_flg: true}
  - 期待値: {qualified: false, reasons: ["破産手続き中"]}
- **T-UT-016**: 複数欠格フラグありの企業
  - 入力: {bankruptcy_flg: true, violent_relation_flg: true}
  - 期待値: {qualified: false, reasons: ["破産手続き中", "暴力団関係"]}

### 3.3 判定エンジン

#### 3.3.1 DisqualificationJudge.gs
**テスト対象関数**: `judgeDisqualification()`
- **T-UT-017**: 全条件クリアの企業
  - 入力: 欠格フラグなしの企業データ
  - 期待値: {result: "適格", message: ""}
- **T-UT-018**: 単一欠格要件該当
  - 入力: 社会保険滞納フラグありの企業データ
  - 期待値: {result: "不適格", message: "社会保険料等の滞納があります"}
- **T-UT-019**: 複数欠格要件該当
  - 入力: 複数フラグありの企業データ
  - 期待値: {result: "不適格", message: 複数の欠格理由を含む}

#### 3.3.2 GradeJudge.gs
**テスト対象関数**: `checkGradeRequirement()`
- **T-UT-020**: 等級要件を満たす場合
  - 入力: 要件 "土木A", 企業等級 "土木A"
  - 期待値: {result: true, message: ""}
- **T-UT-021**: 等級要件を満たさない場合
  - 入力: 要件 "土木A", 企業等級 "土木B"
  - 期待値: {result: false, message: "等級が不足しています"}
- **T-UT-022**: 同等以上条件
  - 入力: 要件 "土木B以上", 企業等級 "土木A"
  - 期待値: {result: true, message: ""}

#### 3.3.3 RegionJudge.gs
**テスト対象関数**: `checkRegionRequirement()`
- **T-UT-023**: 地域要件を満たす場合
  - 入力: 要件 "東京都", 拠点所在地 "東京都千代田区"
  - 期待値: {result: true, offices: ["拠点ID"]}
- **T-UT-024**: 地域要件を満たさない場合
  - 入力: 要件 "東京都", 拠点所在地なし
  - 期待値: {result: false, offices: []}
- **T-UT-025**: 複数拠点での判定
  - 入力: 要件 "関東地方", 複数拠点データ
  - 期待値: {result: true, offices: 該当拠点リスト}

#### 3.3.4 AchievementJudge.gs
**テスト対象関数**: `checkAchievementRequirement()`
- **T-UT-026**: 実績要件を満たす場合
  - 入力: 要件 "過去3年間に1億円以上", 該当実績あり
  - 期待値: {result: true, achievements: [実績リスト]}
- **T-UT-027**: 実績要件を満たさない場合
  - 入力: 要件 "過去3年間に1億円以上", 該当実績なし
  - 期待値: {result: false, achievements: []}
- **T-UT-028**: 工事成績要件
  - 入力: 要件 "平均75点以上", 実績データ
  - 期待値: 平均点計算結果に基づく判定

#### 3.3.5 EngineerJudge.gs
**テスト対象関数**: `checkEngineerRequirement()`
- **T-UT-029**: 必要資格保有者あり
  - 入力: 要件 "1級土木施工管理技士", 該当者あり
  - 期待値: {result: true, engineers: [技術者リスト]}
- **T-UT-030**: 必要資格保有者なし
  - 入力: 要件 "1級土木施工管理技士", 該当者なし
  - 期待値: {result: false, engineers: []}
- **T-UT-031**: 同等資格での判定
  - 入力: 要件 "土木施工管理技士", "技術士（建設部門）"保有者
  - 期待値: {result: true, engineers: [技術者リスト]}

### 3.4 外部連携

#### 3.4.1 OCRConnector.gs
**テスト対象関数**: `sendToOCR()`
- **T-UT-032**: 正常なPDF URLでの処理
  - 入力: 有効なPDF URL
  - 期待値: 処理IDの返却
- **T-UT-033**: 無効なURLでの処理
  - 入力: 不正なURL形式
  - 期待値: エラー
- **T-UT-034**: タイムアウト処理
  - 入力: レスポンス遅延をシミュレート
  - 期待値: タイムアウトエラー

---

## 4. 結合テスト仕様

### 4.1 ワークフロー結合テスト

#### 4.1.1 正常フロー
**T-IT-001**: 単一公告の完全処理
- **前提条件**: 判定前公告一覧に1件のデータ
- **実行手順**:
  1. ワークフロー実行
  2. 転記処理確認
  3. OCR処理確認
  4. 判定処理確認
  5. レポート生成確認
- **期待結果**: 全工程が正常に完了し、レポートが生成される

#### 4.1.2 バッチ処理
**T-IT-002**: 100件バッチ処理
- **前提条件**: 判定前公告一覧に100件のデータ
- **実行手順**:
  1. ワークフロー実行
  2. バッチ分割確認
  3. 進捗管理確認
  4. 全件処理確認
- **期待結果**: 適切なバッチサイズで処理され、全件完了

### 4.2 タイムアウト処理

**T-IT-003**: タイムアウトと再開
- **前提条件**: 処理時間が5分を超えるデータ量
- **実行手順**:
  1. ワークフロー実行
  2. 5分でタイムアウト確認
  3. トリガーによる再開確認
  4. 処理継続確認
- **期待結果**: 中断点から正しく再開される

**T-IT-004**: 複数回タイムアウト
- **前提条件**: 3回以上のタイムアウトが必要なデータ量
- **実行手順**:
  1. 初回実行
  2. 複数回のタイムアウトと再開
  3. 最終的な完了確認
- **期待結果**: 何度でも正しく再開され、最終的に完了

### 4.3 エラーハンドリング

**T-IT-005**: OCRエラー時の処理継続
- **前提条件**: OCR処理がエラーを返すケース
- **実行手順**:
  1. OCRエラーをシミュレート
  2. エラーログ確認
  3. 後続処理の継続確認
- **期待結果**: エラーが記録され、他の公告は正常処理

**T-IT-006**: マスターデータ不整合
- **前提条件**: 存在しない企業IDを含むデータ
- **実行手順**:
  1. 不正データでワークフロー実行
  2. エラーハンドリング確認
  3. 正常データの処理確認
- **期待結果**: エラーデータはスキップされ、正常データは処理

---

## 5. システムテスト仕様

### 5.1 エンドツーエンドテスト

**T-ST-001**: 新規ユーザーの初回利用
- **シナリオ**:
  1. 初回メニュー表示
  2. 設定入力
  3. サンプルデータでの実行
  4. 結果確認
- **期待結果**: すべての機能が正常に動作

**T-ST-002**: 大量データ処理
- **シナリオ**:
  1. 200件のデータ投入
  2. 処理実行
  3. タイムアウト処理確認
  4. 最終結果確認
- **期待結果**: 全件が正しく処理される

### 5.2 性能テスト

**T-ST-003**: 処理時間測定
- **測定項目**:
  - 1件あたりの平均処理時間
  - 100件バッチの総処理時間
  - API応答時間
- **合格基準**:
  - 1件平均: 30秒以内
  - 100件: 60分以内
  - API応答: 3秒以内

**T-ST-004**: 同時実行テスト
- **シナリオ**:
  - 5ユーザーが同時に処理実行
  - リソース競合確認
  - エラー発生確認
- **期待結果**: 全ユーザーの処理が正常完了

---

## 6. 受入テスト仕様

### 6.1 業務シナリオテスト

**T-UAT-001**: 実際の公告での判定
- **実施者**: エンドユーザー
- **データ**: 実際の入札公告10件
- **確認項目**:
  - 判定結果の妥当性
  - 処理時間の許容性
  - レポートの見やすさ

**T-UAT-002**: 日常運用シミュレーション
- **実施者**: 運用担当者
- **期間**: 1週間
- **確認項目**:
  - 操作の簡便性
  - エラー対応の容易さ
  - 運用上の問題点

### 6.2 ユーザビリティテスト

**T-UAT-003**: UI/UX評価
- **評価項目**:
  - メニューの分かりやすさ
  - エラーメッセージの適切性
  - 処理進捗の可視性
  - ヘルプ機能の充実度

---

## 7. テスト実施手順

### 7.1 テスト準備
1. テスト環境の構築
   - テスト用スプレッドシートの作成
   - テストデータの準備
   - 外部サービスのモック設定

2. テストデータ準備
   - マスターデータのコピー
   - テストケース用データの作成
   - 期待値の定義

### 7.2 テスト実行
1. 単体テスト
   - 各関数の個別実行
   - 結果の記録
   - 不具合の報告

2. 結合テスト
   - シナリオに沿った実行
   - ログの確認
   - データの整合性確認

3. システムテスト
   - 本番環境に近い設定
   - 実運用を想定した操作
   - 性能測定

### 7.3 テスト完了基準
- 全テストケースの実施
- 重大な不具合の解消
- 性能基準の達成
- ユーザー承認の取得

---

## 8. 不具合管理

### 8.1 不具合分類
- **Critical**: システム停止、データ破損
- **Major**: 主要機能の不動作
- **Minor**: 軽微な機能不具合
- **Trivial**: UIの不具合、誤字

### 8.2 対応優先度
1. Critical: 即時対応
2. Major: 24時間以内
3. Minor: 次回リリース
4. Trivial: 時間があれば対応

---

## 9. リスクと対策

### 9.1 テストリスク
| リスク | 影響 | 対策 |
|--------|------|------|
| 外部API依存 | テスト不可 | モックAPI使用 |
| 大量データ | 時間超過 | サンプリング |
| 環境差異 | 結果不一致 | 環境統一 |

### 9.2 品質リスク
| リスク | 影響 | 対策 |
|--------|------|------|
| 判定精度 | 誤判定 | ルール精査 |
| 性能劣化 | タイムアウト | 最適化 |
| データ不整合 | エラー | 検証強化 |

---

## 改訂履歴
- 2024-01-XX: 初版作成