# 入札公告要件判定システム - 開発仕様書

## 関連ドキュメント
- **システムアーキテクチャ**: `/docs/design/System_Architecture.md`
- **要件定義書**: `/docs/requirements/要件定義書.md`
- **マスター項目一覧**: `/docs/requirements/appendix/別紙1：マスター項目一覧.md`
- **判定詳細**: `/docs/requirements/appendix/別紙2：入札公告要件判定詳細.md`
- **補助シート**: `/docs/requirements/appendix/別紙3：補助シート.md`
- **TODO リスト**: `/docs/todo/Project_TODO.md`
- **テスト仕様**: `/docs/test/Project_Test.md`

---

## 1. システム概要

### 1.1 目的
公共工事の入札公告における複雑な要件を自動判定し、企業の入札参加可否を迅速に判断するシステムを構築する。

### 1.2 主要機能
1. **入札公告管理**: PDF URLの登録と管理
2. **OCR処理**: 外部OCRツールによる公告文書の解析
3. **要件判定**: ルールベースによる自動判定
4. **結果レポート**: 判定結果の可視化と改善提案

### 1.3 成功指標
- 100件以上の公告を一括処理可能
- 判定精度 95%以上
- 処理時間 1公告あたり平均30秒以内

### 1.4 ユーザーペルソナ
1. **営業担当者**: 入札案件を探し、自社が参加可能か迅速に判断したい
2. **営業責任者**: 複数案件の判定結果を俯瞰し、戦略的に入札を決定したい
3. **システム管理者**: マスターデータの更新や判定ルールの調整を行いたい

### 1.5 利用シナリオ
```
┌─────────────────┐
│ 1. ログイン      │  ← Googleアカウント認証
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 2. 公告登録      │  ← CSVまたは手動入力
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 3. 一括判定実行  │  ← 100件を自動処理
└────────┬────────┘
         │ (非同期処理)
         ▼
┌─────────────────┐
│ 4. 結果確認      │  ← レポート生成・ダウンロード
└─────────────────┘
```

---

## 2. アーキテクチャ設計

### 2.1 システム構成

詳細は[システムアーキテクチャ設計書](/docs/design/System_Architecture.md)を参照してください。

```
┌─────────────────────────────────────────────────────────────┐
│                        ユーザー環境                          │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────────┐    ┌──────────────────┐            │
│  │ クライアント側    │    │ マスター管理用   │            │
│  │ スプレッドシート  │    │ スプレッドシート │            │
│  │ (src/client)     │    │ (src/master)    │            │
│  └────────┬─────────┘    └────────┬─────────┘            │
│           └─────────┬──────────────┘                       │
│                    ↓                                       │
│         ┌────────────────────────┐                          │
│         │ サーバー側ライブラリ   │                          │
│         │ (src/server)           │                          │
│         │ ※共有ライブラリ提供    │                          │
│         └────────────────────────┘                          │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│                       外部サービス                           │
├─────────────────────────────────────────────────────────────┤
│  ・OCR API (公告PDF解析)                                    │
│  ・LLM API (要件抽出・分類)                                 │
│  ・Google Services (Drive, Sheets API)                      │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 データフロー
1. **入力フェーズ**: 判定前公告一覧 → 入札公告マスター
2. **OCR フェーズ**: PDF → OCR → 公告要件マスター
3. **判定フェーズ**: 要件 × 企業 → 判定結果
4. **出力フェーズ**: 判定結果 → 報告用シート

---

## 3. モジュール設計

詳細なモジュール構成は[システムアーキテクチャ設計書](/docs/design/System_Architecture.md)を参照してください。

### 3.1 クライアント側モジュール (src/client)

#### 3.1.1 MainController.gs (src/client/Controller/)
- **責務**: ワークフロー全体の制御
- **主要関数**:
  ```javascript
  /**
   * ワークフロー実行のメインエントリーポイント
   * @param {Object} options - 実行オプション
   * @param {boolean} options.isResume - 再開フラグ
   * @param {number} options.batchSize - バッチサイズ
   * @returns {Object} 実行結果
   */
  function executeWorkflow(options = {}) {
    // 1. 初期化処理
    // 2. 進捗状態の読み込み
    // 3. タイムアウトトリガー設定
    // 4. バッチ処理実行
    // 5. 完了処理
  }
  
  /**
   * タイムアウト時の再開処理
   * @param {Event} e - トリガーイベント
   */
  function handleTimeout(e) {
    // 1. 保存された状態を読み込み
    // 2. 再開ポイントから処理継続
    // 3. 新しいトリガー設定
  }
  ```

#### 3.1.2 UIManager.gs (src/client/UI/)
- **責務**: カスタムメニューとUI制御
- **主要関数**:
  - `createCustomMenu()`: メニュー作成
  - `showProgressDialog()`: 進捗表示

#### 3.1.3 DataValidator.gs (src/client/Data/)
- **責務**: 入力データの検証
- **主要関数**:
  - `validateInput()`: 必須項目チェック
  - `parseDates()`: 日付パース処理

### 3.2 サーバー側モジュール（ライブラリ）(src/server)

#### 3.2.1 JudgmentEngine.gs (src/server/Judgment/)
- **責務**: 要件判定の中核処理
- **主要関数**:
  - `executeJudgment()`: 統合判定実行
  - `aggregateResults()`: 判定結果集約

#### 3.2.2 OCRConnector.gs (src/server/External/)
- **責務**: 外部OCR APIとの連携
- **主要関数**:
  - `sendToOCR()`: OCR処理要求
  - `parseOCRResult()`: 結果パース

### 3.3 マスター管理モジュール (src/master)

#### 3.3.1 AdminMenu.gs (src/master/Admin/)
- **責務**: 管理者向け機能の提供
- **主要関数**:
  - `createAdminMenu()`: 管理メニュー作成
  - `importMasterData()`: マスターデータインポート

---

## 4. データ設計

### 4.1 スプレッドシート構成

#### 4.1.1 クライアント側スプレッドシート
| シート名 | 用途 | 主要カラム |
|----------|------|------------|
| 判定前公告一覧 | 判定対象の公告情報 | 公告ID, 公告名, PDF URL, ステータス |
| 判定後公告一覧 | 判定結果サマリー | 公告ID, 判定日時, 適格企業数, 処理時間 |
| 入札公告詳細 | 公告の詳細情報 | 公告ID, 発注機関, 工事概要, 要件一覧 |
| レポート | 判定結果レポート | 企業ID, 企業名, 判定結果, NG理由 |

#### 4.1.2 マスタースプレッドシート
| シート名 | 用途 | 主要カラム |
|----------|------|------------|
| 企業マスター | 企業基本情報 | 企業ID, 企業名, 各種欠格フラグ |
| 拠点マスター | 企業の拠点情報 | 拠点ID, 企業ID, 所在地, 拠点種別 |
| 従業員マスター | 技術者情報 | 従業員ID, 拠点ID, 資格情報 |
| ライセンス・実績マスター | 許可・実績情報 | 参照ID, カテゴリ, 詳細情報 |

### 4.2 データモデル

```javascript
// 公告情報
const Announcement = {
  id: String,              // 公告ID
  name: String,            // 公告名
  pdfUrl: String,          // PDF URL
  issuer: String,          // 発注機関
  publishDate: Date,       // 公告日
  deadline: Date,          // 入札締切日
  requirements: Object,    // 要件オブジェクト
  status: String          // 処理ステータス
};

// 判定結果
const JudgmentResult = {
  announcementId: String,  // 公告ID
  companyId: String,       // 企業ID
  overallResult: String,   // 総合判定結果
  details: {
    disqualification: Object,  // 欠格要件判定
    grade: Object,            // 等級要件判定
    region: Object,           // 地域要件判定
    achievement: Object,      // 実績要件判定
    engineer: Object          // 技術者要件判定
  },
  timestamp: Date         // 判定日時
};
```

---

## 5. 処理フロー設計

### 5.1 メイン処理フロー
```
┌─────────────────┐
│ 1. 初期化処理   │
└────────┬────────┘
         ↓
┌─────────────────┐
│ 2. データ読込   │ ← 判定前公告一覧から
└────────┬────────┘
         ↓
┌─────────────────┐
│ 3. バッチ分割   │ ← 100件単位
└────────┬────────┘
         ↓
┌─────────────────┐
│ 4. OCR処理      │ ← 並列実行
└────────┬────────┘
         ↓
┌─────────────────┐
│ 5. 要件判定     │ ← 6種類の判定を実行
└────────┬────────┘
         ↓
┌─────────────────┐
│ 6. 結果保存     │ → 判定後公告一覧へ
└────────┬────────┘
         ↓
┌─────────────────┐
│ 7. レポート生成 │
└─────────────────┘
```


### 5.2 タイムアウト処理
- 実行時間が5分を超えた場合、自動的に処理を中断
- 処理状態を保存し、トリガーを設定して1分後に再開
- 再開時は中断したポイントから処理を継続

### 5.3 エラーハンドリング
- 各処理ステップでtry-catchによるエラー捕捉
- エラー発生時も他の公告の処理は継続
- エラー情報はログシートに記録

---

## 6. API設計

### 6.1 サーバー側ライブラリ公開API

```javascript
/**
 * 企業の判定を実行
 * @param {string} companyId - 企業ID
 * @param {Object} requirements - 要件オブジェクト
 * @returns {Object} 判定結果
 */
function executeJudgment(companyId, requirements) {
  // 実装
}

/**
 * 企業情報を取得
 * @param {string} companyId - 企業ID
 * @returns {Object} 企業情報
 */
function getCompanyData(companyId) {
  // 実装
}

/**
 * 判定結果を取得
 * @param {string} evaluationId - 評価ID
 * @returns {Object} 判定結果詳細
 */
function getJudgmentResult(evaluationId) {
  // 実装
}
```

### 6.2 外部API連携

#### OCR API
- エンドポイント: 設定により指定
- メソッド: POST
- リクエスト: PDF URL
- レスポンス: テキスト抽出結果

#### LLM API
- エンドポイント: 設定により指定
- メソッド: POST
- リクエスト: 抽出テキスト + プロンプト
- レスポンス: 構造化された要件情報

---

## 7. セキュリティ設計

### 7.1 アクセス制御
- Google アカウントによる認証
- スプレッドシートの共有設定による権限管理
- ライブラリは読み取り専用アクセス

### 7.2 データ保護
- APIキーは PropertiesService で管理
- 個人情報を含むログは最小限に
- HTTPSによる通信の暗号化

### 7.3 監査
- 全操作をログシートに記録
- 実行者、実行時間、処理内容を保存

---

## 8. パフォーマンス設計

### 8.1 処理の最適化
- バッチ処理による効率化（50-100件単位）
- 並列処理可能な部分は UrlFetchApp.fetchAll() を使用
- キャッシュサービスによるマスターデータのキャッシング

### 8.2 制限事項への対応
- スクリプト実行時間: 6分制限 → 5分でタイムアウト処理を実行
- API呼び出し回数: 日次制限内に収まるよう設計
- スプレッドシートセル数: 1000万セル制限を考慮

---

## 9. 開発ガイドライン

### 9.1 コーディング規約
- 関数名: キャメルケース（例: executeWorkflow）
- 変数名: キャメルケース（例: companyData）
- 定数名: アッパースネークケース（例: MAX_BATCH_SIZE）
- コメント: JSDoc形式で記述

### 9.2 モジュール設計原則
- 単一責任の原則（SRP）を遵守
- 各モジュールは300行以内
- 依存関係は最小限に

### 9.3 テスト方針
- 単体テスト: 各関数の動作確認
- 結合テスト: モジュール間連携の確認
- E2Eテスト: 実際のシナリオでの動作確認

---

## 10. デプロイメント

### 10.1 開発環境
- ローカル開発: clasp を使用
- バージョン管理: Git
- コード共有: GitHub

### 10.2 リリース手順
1. サーバー側ライブラリの更新とバージョニング
2. クライアント側のライブラリ参照更新
3. 動作確認テストの実施
4. 本番環境へのデプロイ

### 10.3 ロールバック手順
1. ライブラリのバージョンを前バージョンに戻す
2. クライアント側の参照を更新
3. 動作確認

---

## 改訂履歴
- 2024-01-XX: 初版作成
- 2024-01-XX: システムアーキテクチャの明確化（3層構造）