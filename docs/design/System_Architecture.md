# 入札公告要件判定システム - システムアーキテクチャ設計

## 概要
本システムは、Google Apps Script (GAS) を基盤とした3層構造のシステムです。

## システム構成

### 1. 全体構成図
```
┌─────────────────────────────────────────────────────────────────┐
│                           ユーザー環境                            │
├─────────────────────────────────────────────────────────────────┤
│  ┌────────────────────┐    ┌────────────────────┐              │
│  │ クライアント側      │    │ マスター管理用     │              │
│  │ スプレッドシート    │    │ スプレッドシート   │              │
│  │ (Client)           │    │ (Master)          │              │
│  └──────────┬─────────┘    └──────────┬─────────┘              │
│             │                         │                          │
│             └───────────┬─────────────┘                          │
│                         ↓                                        │
│            ┌────────────────────────┐                           │
│            │ サーバー側ライブラリ   │                           │
│            │ (Server Library)      │                           │
│            └────────────────────────┘                           │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                         外部サービス                              │
├─────────────────────────────────────────────────────────────────┤
│  ┌────────────┐    ┌────────────┐    ┌────────────┐          │
│  │ OCR API    │    │ LLM API    │    │ Google     │          │
│  │            │    │            │    │ Services   │          │
│  └────────────┘    └────────────┘    └────────────┘          │
└─────────────────────────────────────────────────────────────────┘
```

## 2. 各コンポーネントの詳細

### 2.1 クライアント側スプレッドシート（Client）

**役割**: エンドユーザーが直接操作するインターフェース

**構成**:
```
src/client/
├── UI/                     # ユーザーインターフェース
│   ├── UIManager.gs       # UI制御
│   ├── MenuBuilder.gs     # カスタムメニュー
│   └── DialogManager.gs   # ダイアログ管理
├── Controller/            # 制御層
│   ├── MainController.gs  # メイン制御
│   ├── StateManager.gs    # 状態管理
│   └── TimeoutHandler.gs  # タイムアウト処理
├── Data/                  # データ層
│   ├── DataManager.gs     # データ管理
│   ├── DataValidator.gs   # データ検証
│   └── SheetManager.gs    # シート操作
└── Report/                # レポート生成
    ├── ReportGenerator.gs # レポート生成
    └── ChartBuilder.gs    # グラフ作成
```

**シート構成**:
- 判定前公告一覧
- 判定後公告一覧
- 入札公告詳細
- レポート
- 設定

### 2.2 サーバー側ライブラリ（Server Library）

**役割**: 判定ロジックとマスターデータアクセスを提供する共有ライブラリ

**構成**:
```
src/server/
├── Config/                # 設定
│   ├── Config.gs         # システム設定
│   └── Constants.gs      # 定数定義
├── Common/               # 共通機能
│   ├── Utils.gs          # ユーティリティ
│   ├── Logger.gs         # ログ管理
│   └── ErrorHandler.gs   # エラーハンドリング
├── DataAccess/           # データアクセス層
│   ├── MasterDataAccess.gs    # マスターデータアクセス
│   ├── CacheManager.gs        # キャッシュ管理
│   └── QueryBuilder.gs        # クエリ構築
├── Judgment/             # 判定エンジン
│   ├── JudgmentEngine.gs      # 判定エンジン統括
│   ├── DisqualificationJudge.gs # 欠格要件判定
│   ├── GradeJudge.gs          # 等級要件判定
│   ├── RegionJudge.gs         # 地域要件判定
│   ├── AchievementJudge.gs    # 実績要件判定
│   └── EngineerJudge.gs       # 技術者要件判定
└── External/             # 外部連携
    ├── OCRConnector.gs        # OCR API連携
    ├── LLMConnector.gs        # LLM API連携
    └── APIClient.gs           # 汎用APIクライアント
```

**公開インターフェース**:
```javascript
// ライブラリとして公開される関数
function executeJudgment(companyId, requirements) {}
function getCompanyData(companyId) {}
function getJudgmentResult(evaluationId) {}
```

### 2.3 マスター管理用スプレッドシート（Master）

**役割**: マスターデータの管理と更新を行う管理者用インターフェース

**構成**:
```
src/master/
├── Admin/                 # 管理機能
│   ├── AdminMenu.gs      # 管理者メニュー
│   ├── DataImporter.gs   # データインポート
│   └── DataExporter.gs   # データエクスポート
├── Maintenance/          # メンテナンス
│   ├── DataValidator.gs  # データ整合性チェック
│   ├── BackupManager.gs  # バックアップ管理
│   └── VersionManager.gs # バージョン管理
└── Sync/                 # 同期機能
    ├── SyncManager.gs    # 同期管理
    └── ConflictResolver.gs # 競合解決
```

**シート構成**:
- 企業マスター
- 拠点マスター
- 従業員マスター
- ライセンス・実績マスター
- 評価マスター
- システムログ
- 設定

## 3. データフロー

### 3.1 判定処理フロー
```
[クライアント]
    ↓ 1. 判定要求
[サーバーライブラリ]
    ↓ 2. マスターデータ取得
[マスター管理]
    ↓ 3. データ返却
[サーバーライブラリ]
    ↓ 4. 判定処理実行
    ↓ 5. 結果返却
[クライアント]
    ↓ 6. 結果表示
```

### 3.2 マスターデータ更新フロー
```
[マスター管理]
    ↓ 1. データ更新
    ↓ 2. 整合性チェック
    ↓ 3. バージョン更新
[サーバーライブラリ]
    ↓ 4. キャッシュクリア
```

## 4. セキュリティ設計

### 4.1 アクセス制御
- **クライアント**: ユーザー権限で実行
- **サーバーライブラリ**: 読み取り専用アクセス
- **マスター管理**: 管理者権限必須

### 4.2 データ保護
- マスターデータは読み取り専用で公開
- 個人情報は暗号化して保存
- APIキーは環境変数で管理

## 5. 非機能要件

### 5.1 パフォーマンス
- 1件あたりの判定時間: 30秒以内
- 同時処理可能数: 5ユーザー
- キャッシュ有効期間: 1時間

### 5.2 可用性
- 稼働時間: 24/7（メンテナンス時除く）
- タイムアウト自動復旧機能
- エラー時の部分的処理継続

### 5.3 拡張性
- モジュール単位での機能追加
- 判定ルールの柔軟な変更
- 外部APIの追加対応

## 6. 開発・デプロイ方針

### 6.1 開発環境
- 各コンポーネントは独立したGASプロジェクト
- Git連携によるバージョン管理
- clasp CLIによるローカル開発

### 6.2 デプロイ手順
1. サーバーライブラリの更新とバージョニング
2. マスター管理スプレッドシートの設定
3. クライアントスプレッドシートのライブラリ参照更新

## 7. 運用・保守

### 7.1 監視項目
- API使用量
- エラー発生率
- 処理時間統計

### 7.2 定期メンテナンス
- マスターデータの整合性チェック（週次）
- ログファイルのローテーション（月次）
- パフォーマンスレビュー（四半期）