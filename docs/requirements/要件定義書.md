# **入札公告要件判定システム 要件定義書**

## **1\. システム概要**

### **1.1 背景・目的**

公共工事の入札公告には、下記のように**非常に多様な要件**が含まれます。

* **欠格要件**（破産者除外、暴力団関係NG、会社更生法手続中NGなど）  
* **等級要件**（A～D等級、経営事項評価数値スコア など）  
* **地域要件**（特定地域内に本店/営業所があること）  
* **実績要件**（工事成績65点以上、RC造面積○○㎡以上、JV出資比率20％以上など）  
* **技術者要件**（1級施工管理技士、監理技術者資格者証、同等資格…）  
* **その他要件**（情報保全体制、社会保険加入など）  
* **JV要件**（共同企業体の代表企業等級・出資比率合計など）…ただし現時点では手動確認

従来、公告文を人力で読み解いて「自社が参加資格を満たすか」を判定していたため、**多大な時間とコスト**がかかっていました。  
 そこで本システムでは、**OCR＋LLM**を使ってPDF公告から要件を自動抽出し、**企業マスター**等と照合して**OK/NG/不足要件**を素早く判定する仕組みを構築します。

#### **目的**

1. 公告PDFを迅速にテキスト化し、要件をリスト化  
2. 企業DB（スプレッドシート）と付き合わせて、自動的に参加可否/不足要件を判定  
3. 担当者が**不足要件**を把握し、改善策（LLM提案も含む）を検討できるよう支援  
4. 複数人同時実行に対応した分散処理アーキテクチャ
5. 今後のJV対応や実績判定高度化にも柔軟に拡張可能なアーキテクチャを確立

### **1.2 システムの特徴**

1. **OCR+LLM連携**:  
   * OCRでPDFをテキスト化し、LLMが公告文中の「要件」を抽出  
   * 同時に「数値要件」や「資格要件」なども解析し、システムが取り込みやすい形へ  
2. **ルールベース判定**:  
   * 抽出された要件をルールベースやコード内IF文を使い、機械的に合否チェック  
   * 各要件（欠格/等級/地域/実績/技術者/その他）ごとに判定結果を記録  
3. **サーバー・クライアント分離アーキテクチャ**:  
   * 基幹マスターはサーバー側、動的データはクライアント側で管理  
   * 中核処理・APIはサーバー側のライブラリとして実装  
   * ワークフロー進捗管理はクライアント側で実施  
4. **JV要件は将来拡張**:  
   * 現フェーズでは「JV要件がある場合は手動確認を誘導」  
   * 後日、共同企業体の構成員等級合算など自動化を想定

---

## **2\. 業務範囲と要件判定方針**

### **2.1 業務範囲（機能概要）**

1. **入札公告登録・転記**  
   * 判定前公告一覧への初期入力（工事名、省庁名、実発注機関名、PDF URL等）  
   * 入札公告マスターへの転記処理  
2. **OCR＋LLM解析**  
   * PDF→テキスト抽出＋要件文言抽出（欠格/等級/地域/実績/技術者/その他に分類）  
   * 外部OCRツールとの連携、結果の受信と格納  
3. **要件判定処理**  
   * 要件拠点中間テーブルへの登録  
   * 各要件種別ごとの判定実行（欠格→等級→地域→実績→技術者→その他の順）  
   * 企業マスター（M_COMPANYなど）と照合し、OK/NGを決定  
4. **判定結果管理**  
   * T_BID_EVALUATION（企業公告判定マスター）への結果記録  
   * T_BID_SUFFICIENCY_DETAIL（充足要件リスト）への記録  
   * T_BID_SHORTAGE_DETAIL（不足要件リスト＋改善アドバイス）への記録  
5. **報告用シート作成**  
   * 判定結果を集約した報告用シートの自動生成  

### **2.2 要件種別の整理**

**別紙2**で詳細記載しますが、要件種別は以下の通りです。

* **欠格要件**: 予決令70/71条、破産者、暴力団、更生法手続中、指名停止中、情報保全体制、社会保険滞納など  
* **業種・等級要件**: D等級以上、C等級以上、license_scoreが○点以上、特定工事種別の登録  
* **地域要件**: 特定地域内に本店/営業所があること  
* **実績要件**: ○年度以降の工事成績65点以上、RC造××㎡以上、JV比率20%以上で元請扱い等  
* **技術者要件**: 1級or2級施工管理技士、監理技術者資格者証、技術士等  
* **その他要件**: 上記に分類されないその他の要件  
* **JV要件**: 将来対応とし現状は手動確認へ誘導

各要件の文言は**LLM**が抽出し、「T_BID_REQUIREMENT」に格納。  
システムはそれを読んで**ルールベース**でNG/OK判定を下します。

---

## **3\. システム構成（詳細）**

### **3.1 全体ワークフロー**

#### **3.1.1 基本フロー**

1. **初期入力**  
   * ユーザーが判定前公告一覧に必須項目（工事名、省庁名、実発注機関名、PDF URL）を入力  
   * 100件以上の一括入力を想定  
   * カスタムメニューから「入札公告判定」→「一括実行」を選択  

2. **データ転記**  
   * 判定前公告一覧から入札公告マスターへ情報を転記  
   * 外部OCRツールへデータを送信  

3. **OCR処理**  
   * 外部ツールでOCR実行  
   * 結果を入札公告マスターおよび公告要件マスターへ反映  
   * 要件種別の分類（欠格/等級/地域/実績/技術者/その他）  

4. **判定枠作成**  
   * 企業公告判定マスターに「公告×拠点」の組み合わせで判定枠を作成  

5. **欠格要件判定**  
   * 企業マスターのフラグを一括チェック  
   * 不足要件リストマスターへ記録  
   * 企業公告判定マスターへ反映  
   * 公告要件マスターの欠格要件に「判定済み」フラグを設定  

6. **中間テーブル登録・その他要件判定**  
   * 判定済みフラグが立っていない要件のみを要件拠点中間テーブルに登録  
   * 1行ずつ判定実行  
   * 充足/不足要件リストマスターへ記録  
   * 企業公告判定マスターへ反映  

7. **報告用シート作成**  
   * 最終ステータス設定（ALL CLEAR/NG有）  
   * 各マスターから必要情報を取得して報告用シートを完成

#### **3.1.2 進捗管理とタイムアウト対策**

1. **進捗管理**  
   * 各処理ステップごとに進捗状況を記録  
   * クライアント側のプロパティサービスまたは専用シートで管理  
   * ステータス: 未開始/転記中/OCR中/判定中/完了  
   * 処理済み行番号を記録  

2. **タイムアウト対策**  
   * 処理開始時に7分後のトリガーを自動セット  
   * 5分経過前に自動的に処理を中断し、進捗を保存  
   * トリガー起動時は保存された進捗から再開  
   * 処理完了時はトリガーを削除  

3. **バッチ処理**  
   * 100件以上の大量処理は自動的にバッチ分割  
   * 1バッチあたり10～20件程度で処理  
   * バッチ間で進捗を保存  

4. **エラーリカバリ**  
   * 各ステップでエラーが発生した場合、該当行をスキップ  
   * エラー内容をログシートに記録  
   * 全体処理終了後、エラー行のみ再実行可能

### **3.2 システムアーキテクチャ**

#### **サーバー側**
* **基幹マスター管理**  
  - M_AGENCY（発注者機関マスター）  
  - M_CONSTRUCTION_TYPE（営業品目マスター）  
  - M_QUALIFICATION（技術者資格マスター）  
  - M_COMPANY（企業マスター）  
  - M_OFFICE（拠点マスター）  
  - T_OFFICE_LICENSE（拠点登録許可マスター）  
  - M_EMPLOYEE（従業員マスター）  
  - T_EMPLOYEE_QUAL（従業員資格マスター）  
  - T_OFFICE_EXPERIENCE（拠点工事実績マスター）  
  - T_EMPLOYEE_EXPERIENCE（従業員工事経験マスター）  

* **中核処理ライブラリ**  
  - OCR/LLM API連携  
  - 要件判定ロジック  
  - データ検証・整合性チェック  

#### **クライアント側**
* **動的データ管理**  
  - T_PRE_JUDGMENT_ANNOUNCEMENT（判定前公告一覧）  
  - T_BID_ANNOUNCEMENT（入札公告マスター）  
  - T_BID_REQUIREMENT（公告要件マスター）  
  - T_BID_EVALUATION（企業公告判定マスター）  
  - T_BID_SUFFICIENCY_DETAIL（充足要件リスト）  
  - T_BID_SHORTAGE_DETAIL（不足要件リスト）  
  - T_REQUIREMENT_OFFICE_INTERMEDIATE（要件拠点中間テーブル）  
  - 報告用シート  

* **ワークフロー管理**  
  - 進捗状態の管理  
  - ユーザーインターフェース  
  - カスタムメニュー

### **3.3 データフロー**

1. **判定前公告一覧** → **入札公告マスター** （転記処理）  
2. **入札公告マスター** → **外部OCR** → **公告要件マスター** （要件抽出）  
3. **公告要件マスター** × **拠点マスター** → **要件拠点中間テーブル** （判定対象作成）  
4. **企業マスター** → **要件判定** → **判定結果** （ルールベース判定）  
5. **判定結果** → **充足/不足要件リスト** → **企業公告判定マスター** （結果集約）  
6. **各マスター** → **報告用シート** （レポート生成）

---

## **4\. ルールベース判定（詳細解説）**

OCR+LLMで抽出された要件文言を**T_BID_REQUIREMENT**に格納したうえで、下記の手順で判定します。

### **4.1 判定処理の流れ**

1. **欠格要件一括判定**:  
   * 企業単位で全ての欠格要件をチェック  
   * 判定結果を配列に格納してから書き込み処理を実行
   * 各企業について：
     - 引っかかった欠格要件 → 不足要件リストマスターへ登録
     - 引っかからなかった欠格要件 → 充足要件リストマスターへ登録
   * 書き込み処理の進捗管理：
     - バッチ単位（100件程度）で書き込み
     - 各バッチ完了後に進捗状態を保存
     - 中断時は未書き込みデータと書き込み位置を保持
   * 判定結果を企業公告判定マスターへ反映
   * NGの場合は「[欠格]～」を不足要件メッセージまとめに記載  
   * 最終ステータスを「NG有」に更新  
   * **公告要件マスターの欠格要件に「判定済み」フラグを設定**
   * 欠格要件NGでも他の要件判定を継続

2. **要件拠点中間テーブル作成**:
   * **判定済みフラグが立っていない要件のみを対象**
   * 公告要件マスター × 拠点マスターで中間テーブルを作成
   * 欠格要件は既に判定済みのため、中間テーブルには含まれない
   * これにより処理対象レコード数が大幅に削減（欠格要件×企業数分のレコードが削減）

3. **その他要件の個別判定**:  
   * 要件拠点中間テーブルの1行ずつ処理  
   * 要件種別に応じて該当マスターを参照  
   * 判定結果を充足/不足要件リストマスターへ記録  
   * 企業公告判定マスターの該当要件欄を都度更新  
   * 不足の場合は不足要件メッセージまとめに追記  

4. **判定順序**:  
   * (A) 欠格要件  
   * (B) 業種・等級要件  
   * (C) 地域要件  
   * (D) 実績要件  
   * (E) 技術者要件  
   * (F) その他要件  
   * (Z) JV要件（将来実装）  

### **4.2 判定結果の記録**

* **充足要件**: T_BID_SUFFICIENCY_DETAILへ記録  
* **不足要件**: T_BID_SHORTAGE_DETAILへ記録、改善アドバイスも含む  
* **最終ステータス**:  
  - 全要件OK → 「ALL CLEAR」  
  - NG有り → 「NG有」＋不足要件メッセージまとめを更新（追記式）  

詳細な判定ロジックは**別紙2**にステップごとに記載しています。

---

## **5\. データ構造・テーブル定義**

### **5.1 主要テーブル概要**

**別紙1**にて、以下のテーブル/シートのカラム定義・データ型・制約を一覧表で記載しています。

* **M_COMPANY**(企業マスター): 破産/更生/暴力団フラグなど  
* **M_OFFICE**(拠点マスター): 地域prefectureや支店種別  
* **T_OFFICE_LICENSE**(拠点登録許可マスター): 等級/score/指名停止など  
* **T_OFFICE_EXPERIENCE**(拠点工事実績マスター): 実績(工事成績点、JV比率など)  
* **T_EMPLOYEE_QUAL**(従業員資格マスター): 従業員が保有する資格  
* **T_BID_ANNOUNCEMENT**(入札公告マスター): 入札公告の基本情報(PDF URL等)  
* **T_BID_REQUIREMENT**(公告要件マスター): 抽出された公告要件(1行=1要件)  
* **T_BID_EVALUATION**(企業公告判定マスター): 企業×公告の判定結果(OK/NG/要確認)  
* **T_BID_SHORTAGE_DETAIL**(不足要件リストマスター): 不足要件の具体内容とアドバイス  

### **5.2 追加フィールドの例**

* 実績で「構造RC造/S造」や「延床面積」など細かい条件が登場→`structure_type`や`total_floor_area`等をT_OFFICE_EXPERIENCEに追加  
* 監理技術者資格者証や講習修了証を保持するかはM_QUALIFICATION+T_EMPLOYEE_QUALで管理（例: qualification_name='監理技術者資格者証'）  
* JV出資率や平均成績点などの計算が要る場合は、**システムに計算ロジック**または**DBに集計用カラム**を追加

---

## **6\. 業務フロー：詳細プロセス**

以下、日常運用でのプロセスをさらに詳述します。

### **6.1 初期入力**

1. **判定前公告一覧への入力**
   * 必須項目（T_PRE_JUDGMENT_ANNOUNCEMENT）:  
     - A列: 判定前ID（pre_announcement_no）- 自動付番  
     - B列: 工事名（project_name）- NOT NULL  
     - D列: 省庁名（ministry_name）- NOT NULL  
     - E列: 実発注機関名（issuing_org_name）- NOT NULL  
   * 任意項目:  
     - C列: 公告番号（announcement_no_user）  
     - F列: 公告掲載日（publish_date）- VARCHAR、入力形式自由  
     - G列: 入札説明書交付終了日（doc_distribution_end）- VARCHAR、入力形式自由  
     - H列: 申請書等提出期限（application_deadline）- VARCHAR、入力形式自由  
     - I列: 入札日（opening_date）- VARCHAR、入力形式自由  
     - J列: PDF URL（pdf_url）  
     - L列: 備考（remarks）  

2. **入力チェック**
   * **必須項目チェック**  
     - 工事名: 空白不可  
     - 省庁名: 空白不可、M_AGENCYマスターとの照合推奨  
     - 実発注機関名: 空白不可  
   
   * **日付項目の処理**  
     - F～I列は全てVARCHAR型で自由入力形式  
     - 入札公告マスター転記時にDATE型へパース  
     - パース対応パターン（全角・半角混在対応）:  
       - 年月日指定:  
         - 2024/3/15、2024-3-15、2024.3.15  
         - ２０２４／３／１５（全角）  
         - 2024年3月15日、２０２４年３月１５日  
         - 令和6年3月15日、R6/3/15、R6.3.15  
         - 平成○年、H○年形式も対応  
       - 月日のみ（当年として処理）:  
         - 3/15、3-15、3.15、３／１５  
         - 3月15日、３月１５日  
       - 区切り文字:  
         - スラッシュ（/／）、ハイフン（-－）、ピリオド（.．）  
         - 年月日の漢字区切り  
       - 曜日付き: 「3月15日(金)」→曜日部分は除去  
       - 時刻付き: 「3月15日 15:00」→時刻部分は除去  
     - 前処理:  
       - 全角数字→半角数字変換  
       - 全角記号→半角記号変換  
       - 前後の空白・括弧内除去  
     - パース失敗時:  
       - エラーログに元の入力値を記録  
       - 該当行にエラーフラグを立てる  
       - 処理は継続（スキップ）  
   
   * **URL検証**  
     - PDF URL: http://またはhttps://で始まることを確認  
     - アクセス可能性チェック（オプション）  
   
   * **データクレンジング**  
     - 前後の空白削除（trim）  
     - 全角英数字→半角変換  
     - 制御文字の除去  

### **6.2 一括実行処理**

1. **転記処理**
   * 判定前公告一覧 → 入札公告マスターへデータ転記  
   * 発注機関名から発注機関連番を検索・設定  
   * 優先順位: 手入力データ > OCR結果  

2. **OCR実行**
   * 外部OCRツールへPDF URLを送信  
   * 結果を配列形式で受信  
   * 入札公告マスターの該当項目を更新  
   * 公告要件マスターへ要件を登録  
   * OCR実施済みフラグをONに更新  

3. **要件分類**
   * 各要件を種別ごとに分類:  
     - 欠格要件  
     - 業種・等級要件  
     - 地域要件  
     - 実績要件  
     - 技術者要件  
     - その他要件  
     - JV要件（将来実装）  

### **6.3 判定処理**

#### **6.3.1 基本処理フロー**

1. **判定枠作成**
   * 企業公告判定マスターに「公告×拠点」の組み合わせで枠を作成  
   * 判定連番は公告×拠点単位で順番に付番  

2. **欠格要件判定（一括処理）**
   * 全拠点に対して企業マスターのフラグを一括チェック  
   * NGの場合: 不足要件リストマスターへ記録  
   * 企業公告判定マスターの欠格要件欄を更新  
   * 「[欠格]～」を不足要件メッセージまとめに記載  

3. **中間テーブル登録**
   * 欠格要件以外の要件について「要件×拠点」を要件拠点中間テーブルに登録  
   * 要件判定対象フラグをONに設定  

4. **その他要件判定（個別処理）**
   * 要件拠点中間テーブルを1行ずつ処理  
   * 各要件種別に応じて該当マスターを参照して判定  
   * 充足/不足要件リストマスターへ結果を記録  
   * 判定済みフラグを更新  

5. **企業公告判定マスター更新**
   * 各要件種別の判定結果を反映  
   * 不足要件メッセージまとめを更新（追記式）  
   * 最終ステータスを設定

#### **6.3.2 大量処理対応**

1. **処理状態管理**
   * 処理ステータス管理シートを用意
   * 各公告の処理状態を記録（未処理/転記済/OCR済/判定中/完了）
   * 中間テーブルの判定済みフラグで個別要件の進捗管理

2. **タイムアウト対策**
   * 処理開始時に時間計測開始
   * 5分経過時点で処理を安全に中断
   * 進捗状況を保存して次回実行に備える
   * 中断時は処理中のトランザクションを完了させる

3. **再開処理**
   * 前回の進捗状況から処理を再開
   * 未処理・エラー行のみを対象に処理
   * 完了済みの処理はスキップ

4. **バッチサイズ最適化**
   * OCR処理: 1回あたり10件
   * 判定処理: 1回あたり20～30件（要件数により調整）
   * API呼び出しの待機時間を考慮  

### **6.4 結果出力**

1. **最終ステータス更新**
   * 全要件OK: 「ALL CLEAR」  
   * NG有り: 「NG有」  

2. **報告用シート作成**
   * 各マスターから必要情報を取得  
   * 報告用シートへ自動転記  
   * 作業者名、判定日付を記録

---

## **7\. システムアーキテクチャ図**

サーバー・クライアント分離アーキテクチャを採用した構成です。

```
[サーバー側]
    │
    ├─ 基幹マスター（スプレッドシート/DB）
    │   ├─ M_AGENCY
    │   ├─ M_CONSTRUCTION_TYPE
    │   ├─ M_QUALIFICATION
    │   ├─ M_COMPANY
    │   ├─ M_OFFICE
    │   ├─ T_OFFICE_LICENSE
    │   ├─ M_EMPLOYEE
    │   ├─ T_EMPLOYEE_QUAL
    │   ├─ T_OFFICE_EXPERIENCE
    │   └─ T_EMPLOYEE_EXPERIENCE
    │
    └─ 中核処理ライブラリ（GAS/スタンドアロン）
        ├─ OCR/LLM API連携
        ├─ 要件判定ロジック
        └─ データ検証処理

[クライアント側]
    │
    ├─ 動的データ（スプレッドシート）
    │   ├─ T_PRE_JUDGMENT_ANNOUNCEMENT
    │   ├─ T_BID_ANNOUNCEMENT
    │   ├─ T_BID_REQUIREMENT
    │   ├─ T_BID_EVALUATION
    │   ├─ T_BID_SUFFICIENCY_DETAIL
    │   ├─ T_BID_SHORTAGE_DETAIL
    │   ├─ T_REQUIREMENT_OFFICE_INTERMEDIATE
    │   └─ 報告用シート
    │
    └─ ワークフロー管理（GAS）
        ├─ カスタムメニュー
        ├─ 進捗管理
        └─ ユーザーインターフェース

[外部サービス]
    │
    └─ OCR/LLM API
        ├─ PDF→テキスト変換
        └─ 要件抽出・分類
```

### **処理フロー**

1. **ユーザー** → クライアントシートへ入力
2. **クライアントGAS** → サーバーライブラリ呼び出し
3. **サーバーライブラリ** → 外部OCR/LLM API呼び出し
4. **サーバーライブラリ** → 基幹マスター参照・判定処理
5. **サーバーライブラリ** → 結果をクライアントへ返却
6. **クライアントGAS** → 動的データ更新・報告シート作成

---

## **8\. 運用・保守計画**

### **8.1 運用手順**

1. **（前提）マスター整備**  
   * サーバー側の基幹マスターを正確に登録  
   * 企業情報の各フラグ（bankrupt_flg, violent_relation_flg等）  
   * 拠点の等級・スコア（license_grade, license_score）  
   * 工事実績・技術者資格情報  

2. **公告処理フロー**  
   * 判定前公告一覧へ入力（100件以上可）  
   * 「入札公告判定」→「一括実行」  
   * 自動的にタイムアウトトリガーがセットされる  
   * 処理状況はステータス管理シートで確認  
   * 判定完了後、報告用シートで結果確認  

3. **大量処理時の注意事項**  
   * 100件以上の処理は自動的に分割実行  
   * タイムアウト時は自動的に再開  
   * 処理中断時もデータ整合性は保証  
   * エラー行は後で個別再実行可能  

4. **複数人同時実行対応**  
   * 各ユーザーが独立したクライアントシートで作業  
   * サーバー側マスターは読み取り専用  
   * ワークフロー進捗はクライアント側で管理  

5. **エラー対応**  
   * OCR誤読：PDF URL修正→該当行のみ再実行  
   * 判定誤り：マスターデータ修正→再判定  
   * タイムアウト：自動的に再開（手動介入不要）  
   * システムエラー：ログシートで原因調査  

### **8.2 フェーズ別計画**

* **Phase1**（MVP）  
  * サーバー・クライアント分離構成  
  * 基本的な要件判定機能の実装  
  * 10件程度の公告を同時処理可能  

* **Phase2**（機能拡張）  
  * JV要件の部分的自動化  
  * バッチ処理の高速化  
  * 判定精度の向上  

* **Phase3**（大規模対応）  
  * データベース化  
  * Webアプリケーション化  
  * 認証・権限管理の強化

---

## **9\. セキュリティ・権限管理**

1. **スプレッドシート**  
   * 共有権限を限定し、GASの実行は特定ユーザーのみ可能に  
   * 機密性の高い破産フラグ等を扱うため、編集ユーザーを厳格に管理  
2. **APIキー管理**  
   * OCR+LLM用のAPIキーをGASプロパティに暗号化して保持  
   * ソースコードには書かない  
3. **JV情報**  
   * 将来は共同企業体の構成情報も扱う→機密性高  
   * アクセス権や暗号化が必要  
4. **ログ**  
   * GAS実行ログをクラウドログに残すなど、エラーや改ざんを追跡可能に

---

## **10\. 非機能要件**

### **10.1 性能要件**

1. **処理性能**
   * 100件の公告処理を30分以内に完了
   * 1件あたりの判定処理時間: 平均15秒以内
   * OCR処理: 1PDFあたり30秒以内
   * 同時実行ユーザー数: 最大10ユーザー

2. **応答性能**
   * UI操作の応答時間: 3秒以内
   * 進捗表示の更新間隔: 5秒
   * レポート生成: 10秒以内

3. **リソース使用**
   * GASメモリ使用量: 50MB以下
   * API呼び出し回数: 1日1000回以内
   * スプレッドシートサイズ: 各シート100MB以下

### **10.2 可用性要件**

1. **稼働率**
   * システム稼働率: 99%以上（計画停止除く）
   * 計画停止: 月1回、深夜2時間以内

2. **障害対応**
   * 障害検知: 15分以内
   * 復旧目標時間（RTO）: 4時間以内
   * データ損失許容度（RPO）: 1時間

3. **バックアップ**
   * マスターデータ: 日次バックアップ
   * 処理結果: リアルタイムバックアップ
   * バックアップ保存期間: 3ヶ月

### **10.3 信頼性要件**

1. **データ整合性**
   * トランザクション管理による整合性保証
   * 処理中断時のロールバック機能
   * データ検証機能の実装

2. **エラー処理**
   * 全エラーのログ記録
   * 自動リトライ機能（最大3回）
   * エラー通知機能

3. **監査証跡**
   * 全操作ログの記録
   * ログ保存期間: 1年
   * 改ざん防止機能

---

## **11\. エラー処理詳細**

### **11.1 エラー分類**

| エラー種別 | 説明 | 対処方法 |
|-----------|------|----------|
| 入力エラー | 必須項目未入力、形式不正 | エラーメッセージ表示、再入力促す |
| マスター不整合 | 参照先マスターデータなし | 警告表示、スキップして継続 |
| OCRエラー | PDF読み取り失敗 | 3回リトライ後、手動入力案内 |
| LLMエラー | 要件抽出失敗 | 代替LLM使用、最悪手動分類 |
| タイムアウト | 5分経過 | 自動保存、7分後トリガーで再開 |
| APIエラー | 外部API接続失敗 | エラーログ、管理者通知 |
| システムエラー | 予期せぬエラー | 詳細ログ、即時通知 |

### **11.2 エラー処理フロー**

1. **エラー検知**
   ```javascript
   try {
     // 処理実行
   } catch (error) {
     const errorType = classifyError(error);
     const strategy = getErrorStrategy(errorType);
     handleError(error, strategy);
   }
   ```

2. **リカバリ戦略**
   * **即時リトライ**: ネットワークエラー等
   * **遅延リトライ**: API制限等（30秒後）
   * **スキップ**: データ不正等（ログ記録）
   * **中断**: 致命的エラー（状態保存）

3. **ユーザー通知**
   * エラーレベルに応じた通知
   * 対処方法の明示
   * サポート連絡先の表示

---

## **12\. セキュリティ要件**

### **12.1 アクセス制御**

1. **認証**
   * Google Workspace認証必須
   * 2要素認証推奨
   * セッション管理（30分タイムアウト）

2. **認可**
   * ロールベースアクセス制御（RBAC）
   * 役割: 管理者、オペレーター、閲覧者
   * 最小権限の原則

3. **監査**
   * 全アクセスログの記録
   * 不正アクセス検知
   * 定期的な権限レビュー

### **12.2 データ保護**

1. **機密データ管理**
   * 企業フラグ情報の暗号化
   * APIキーの安全な保管
   * 個人情報のマスキング

2. **通信セキュリティ**
   * HTTPS通信の強制
   * APIトークンの定期更新
   * 通信ログの記録

3. **データ保持**
   * 保持期間の設定
   * 安全な削除手順
   * バックアップの暗号化

---

## **13\. テスト計画**

### **13.1 テスト種別**

1. **単体テスト**
   * 各モジュールの機能確認
   * カバレッジ目標: 80%以上
   * 自動テストの実装

2. **結合テスト**
   * モジュール間連携確認
   * データフロー検証
   * エラー伝播確認

3. **システムテスト**
   * E2Eシナリオテスト
   * 性能テスト（100件処理）
   * 負荷テスト（10ユーザー同時）

4. **受入テスト**
   * ユーザー操作シナリオ
   * 業務フロー確認
   * 判定精度検証

### **13.2 テスト環境**

1. **開発環境**
   * 機能開発・単体テスト用
   * テストデータ使用
   * 開発者のみアクセス可

2. **検証環境**
   * 結合・システムテスト用
   * 本番同等構成
   * QAチームアクセス可

3. **本番環境**
   * 実運用環境
   * 本番データ使用
   * 権限管理厳格化

### **13.3 品質基準**

* バグ密度: 1KLOC あたり5件以下
* 判定精度: 95%以上
* レスポンス時間: 規定値以内
* 可用性: 99%以上

---

## **14\. 用語集**

| 用語 | 説明 |
|------|------|
| GAS | Google Apps Script（開発プラットフォーム） |
| OCR | Optical Character Recognition（光学文字認識） |
| LLM | Large Language Model（大規模言語モデル） |
| 欠格要件 | 入札参加を制限する絶対的な要件 |
| 等級要件 | 企業の規模・能力を示すランク要件 |
| 地域要件 | 本店・営業所の所在地に関する要件 |
| 実績要件 | 過去の工事実績に関する要件 |
| 技術者要件 | 配置予定技術者の資格・経験要件 |
| JV | Joint Venture（共同企業体） |
| マスター | 基準となる固定的なデータ |
| トランザクション | 一連の関連する処理の単位 |
| バッチ処理 | 一定量のデータをまとめて処理する方式 |
| チェックポイント | 処理の中断・再開ポイント |
| トリガー | 自動実行の契機となるイベント |

---

## **15\. 変更管理**

### **15.1 変更プロセス**

1. **変更要求**
   * 変更要求書の作成
   * 影響範囲の分析
   * 優先度の設定

2. **変更承認**
   * 変更諮問委員会でのレビュー
   * ステークホルダー承認
   * リリース計画策定

3. **変更実装**
   * 開発・テスト
   * リリース作業
   * 動作確認

4. **変更完了**
   * 完了報告
   * ドキュメント更新
   * 教育実施

### **15.2 バージョン管理**

* セマンティックバージョニング採用（X.Y.Z）
* X: メジャーバージョン（互換性なし）
* Y: マイナーバージョン（機能追加）
* Z: パッチバージョン（バグ修正）

### **15.3 構成管理**

* Gitによるソースコード管理
* タグによるリリース管理
* ブランチ戦略: Git Flow

---

## **16\. 将来拡張**

1. **LLM高度連携**  
   * 入札公告の図面等もOCR→構造RC/SRCを判別  
   * 「同等資格」判定用マッピングを学習させる  
2. **動的ルール編集GUI**  
   * T_RULE_BASEをシートで編集し、リアルタイムに反映  
3. **JV自動判定**  
   * T_JV_CONTRACT / T_JV_MEMBERを作成し、出資比率合算、構成員の等級合算  
   * 代表企業のA等級、構成員はB等級以上…など  
4. **Webポータル化**  
   * スプレッドシートUIからWebアプリUIへ移行し、多企業がログイン管理  
5. **ビッグデータ分析**  
   * 過去公告の要件傾向、工事成績分布を分析し、受注戦略に活かす

---

## **11\. まとめと結論**

本書は、**入札公告要件判定システム**の要件定義書です。  
 下記のポイントを踏まえ、**別紙1（マスター項目一覧）**と**別紙2（入札公告要件判定詳細）**を合わせて参照してください。

1. **背景/目的**: 公告の煩雑な要件をOCR+LLM＋ルール判定で自動チェックし、企業の入札可否を迅速に判断  

2. **システム構成**:  
   * サーバー・クライアント分離アーキテクチャ  
   * 基幹マスターはサーバー側、動的データはクライアント側で管理  
   * 複数人同時実行に対応した分散処理  

3. **ワークフロー**:  
   * 判定前公告一覧 → 入札公告マスター → OCR処理 → 要件分類 → 判定枠作成 → 欠格要件判定 → 中間テーブル登録 → その他要件判定 → 報告用シート作成  
   * 欠格要件は一括判定、その他要件は中間テーブル経由で個別判定  

4. **判定ロジック**:  
   * (A)欠格 → (B)業種・等級 → (C)地域 → (D)実績 → (E)技術者 → (F)その他 → (Z)JV(将来) の順  
   * 全要件OK → 「ALL CLEAR」、NG有り → 「NG有」＋不足要件メッセージ  

5. **運用・保守**:  
   * サーバー側の基幹マスターを定期更新  
   * クライアント側で判定実行・結果確認  
   * ログシートでエラー追跡・改善  

6. **セキュリティ**:  
   * APIキー・認証情報の厳重管理  
   * 機密性の高いフラグ情報の取り扱い注意  

**最終的には**、本システムにより、多様な入札公告要件を**網羅的に判定**でき、**自社が参加要件を満たすか**を短時間で判断し、不足があれば**具体的な改善アドバイス**まで得られるようになります。

---

### **別紙1：マスター項目一覧**

**（別紙1参照：すべてのテーブル/カラム/データ型/制約/サンプル値を詳細記載）**

---

### **別紙2：入札公告要件判定詳細**

**（別紙2参照：サンプル公告(1～39)に基づく(A)欠格～(Z)JVステップまでの判定フローを省略せず詳細化）**

---

以上が、本業務設計書（最終・詳細版）となります。

