# 入札公告要件判定システム - 開発仕様書

## 関連ドキュメント
- **要件定義書**: `/要件定義書.md`
- **マスター項目一覧**: `/別紙1：マスター項目一覧.md`
- **判定詳細**: `/別紙2：入札公告要件判定詳細.md`
- **補助シート**: `/別紙3：補助シート.md`
- **TODO リスト**: `/Project_TODO.md`
- **テスト仕様**: `/Project_Test.md`

---

## 1. システム概要

### 1.1 目的
公共工事の入札公告における複雑な要件を自動判定し、企業の入札参加可否を迅速に判断するシステムを構築する。

### 1.2 主要機能
1. **入札公告管理**: PDF URLの登録と管理
2. **OCR処理**: 外部OCRツールによる公告文書の解析
3. **要件判定**: ルールベースによる自動判定
4. **結果レポート**: 判定結果の可視化と改善提案

### 1.3 成功指標
- 100件以上の公告を一括処理可能
- 判定精度 95%以上
- 処理時間 1公告あたり平均30秒以内

---

## 2. システムアーキテクチャ

### 2.1 全体構成
```
┌─────────────────────────────────────────────────────────────┐
│                         クライアント側                         │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐     ┌──────────────────────────────┐  │
│  │ Google Sheets    │     │ GAS (ワークフロー管理)       │  │
│  │ - 動的データ     │ ←→ │ - UI制御                    │  │
│  │ - 判定結果       │     │ - 進捗管理                  │  │
│  └─────────────────┘     └──────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                                 ↓↑
┌─────────────────────────────────────────────────────────────┐
│                          サーバー側                           │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐     ┌──────────────────────────────┐  │
│  │ Master Sheets    │     │ GAS ライブラリ              │  │
│  │ - 基幹マスター   │ ←→ │ - 判定ロジック              │  │
│  │ (読み取り専用)   │     │ - OCR/LLM連携              │  │
│  └─────────────────┘     └──────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                                 ↓↑
┌─────────────────────────────────────────────────────────────┐
│                        外部サービス                           │
│  ・OCR API                                                    │
│  ・LLM API (要件抽出・分類)                                   │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 データフロー
1. **入力フェーズ**: 判定前公告一覧 → 入札公告マスター
2. **OCR フェーズ**: PDF → OCR → 公告要件マスター
3. **判定フェーズ**: 要件 × 企業 → 判定結果
4. **出力フェーズ**: 判定結果 → 報告用シート

---

## 3. モジュール設計

### 3.1 クライアント側モジュール

#### 3.1.1 MainController.gs
- **責務**: ワークフロー全体の制御
- **主要関数**:
  - `executeWorkflow()`: 一括実行のエントリーポイント
  - `handleTimeout()`: タイムアウト時の再開処理

#### 3.1.2 UIManager.gs
- **責務**: カスタムメニューとUI制御
- **主要関数**:
  - `createCustomMenu()`: メニュー作成
  - `showProgressDialog()`: 進捗表示

#### 3.1.3 DataValidator.gs
- **責務**: 入力データの検証
- **主要関数**:
  - `validateInput()`: 必須項目チェック
  - `parseDates()`: 日付パース処理

### 3.2 サーバー側モジュール（ライブラリ）

#### 3.2.1 JudgmentEngine.gs
- **責務**: 要件判定の中核処理
- **主要関数**:
  - `judgeDisqualification()`: 欠格要件判定
  - `judgeGrade()`: 等級要件判定
  - `judgeRegion()`: 地域要件判定
  - `judgeAchievement()`: 実績要件判定
  - `judgeEngineer()`: 技術者要件判定

#### 3.2.2 OCRConnector.gs
- **責務**: 外部OCR APIとの連携
- **主要関数**:
  - `sendToOCR()`: OCR処理要求
  - `parseOCRResult()`: 結果パース

#### 3.2.3 MasterDataAccess.gs
- **責務**: マスターデータへのアクセス
- **主要関数**:
  - `getCompanyData()`: 企業情報取得
  - `getOfficeData()`: 拠点情報取得

### 3.3 共通モジュール

#### 3.3.1 Constants.gs
- **責務**: 定数定義
- **内容**: シートID、カラム定義、エラーメッセージ

#### 3.3.2 Utils.gs
- **責務**: 汎用ユーティリティ
- **主要関数**:
  - `convertToHalfWidth()`: 全角半角変換
  - `formatDate()`: 日付フォーマット

#### 3.3.3 Logger.gs
- **責務**: ログ記録
- **主要関数**:
  - `log()`: ログ出力
  - `logError()`: エラーログ

---

## 4. データベース設計

### 4.1 基幹マスター（サーバー側）
1. **M_COMPANY**: 企業マスター
2. **M_OFFICE**: 拠点マスター
3. **M_AGENCY**: 発注機関マスター
4. **M_CONSTRUCTION_TYPE**: 営業品目マスター
5. **M_QUALIFICATION**: 技術者資格マスター
6. **M_EMPLOYEE**: 従業員マスター
7. **T_OFFICE_LICENSE**: 拠点登録許可
8. **T_OFFICE_EXPERIENCE**: 拠点工事実績
9. **T_EMPLOYEE_QUAL**: 従業員資格
10. **T_EMPLOYEE_EXPERIENCE**: 従業員工事経験

### 4.2 動的データ（クライアント側）
1. **T_PRE_JUDGMENT_ANNOUNCEMENT**: 判定前公告一覧
2. **T_BID_ANNOUNCEMENT**: 入札公告マスター
3. **T_BID_REQUIREMENT**: 公告要件マスター
4. **T_BID_EVALUATION**: 企業公告判定マスター
5. **T_BID_SUFFICIENCY_DETAIL**: 充足要件リスト
6. **T_BID_SHORTAGE_DETAIL**: 不足要件リスト
7. **T_REQUIREMENT_OFFICE_INTERMEDIATE**: 要件拠点中間テーブル
8. **報告用シート**: 最終結果レポート
9. **LOG**: システムログ

---

## 5. 処理フロー詳細

### 5.1 メイン処理フロー
```
[開始]
  ↓
[入力検証] → エラー時: エラーログ記録 → [終了]
  ↓
[進捗管理初期化]
  ↓
[タイムアウトトリガー設定（7分後）]
  ↓
[転記処理] ← 再開ポイント1
  ↓
[OCR送信] ← 再開ポイント2
  ↓
[要件分類] ← 再開ポイント3
  ↓
[判定枠作成] ← 再開ポイント4
  ↓
[欠格要件判定（一括）] ← 再開ポイント5
  ↓
[中間テーブル登録] ← 再開ポイント6
  ↓
[その他要件判定（個別）] ← 再開ポイント7
  ↓
[報告書作成] ← 再開ポイント8
  ↓
[トリガー削除]
  ↓
[完了]
```

### 5.2 タイムアウト処理
- 5分30秒経過で安全に中断
- 進捗状態を保存
- トリガー起動時に保存地点から再開

---

## 6. エラー処理

### 6.1 エラー分類
1. **入力エラー**: 必須項目不足、フォーマット不正
2. **システムエラー**: API通信失敗、タイムアウト
3. **業務エラー**: マスター不整合、判定ロジック例外

### 6.2 エラー対応
- 全エラーをログシートに記録
- 処理継続可能な場合はスキップ
- 重大エラー時は処理中断・通知

---

## 7. セキュリティ要件

### 7.1 アクセス制御
- マスターシート: 読み取り専用
- クライアントシート: 編集権限制御
- APIキー: プロパティサービスで暗号化保存

### 7.2 データ保護
- 機密フラグ情報の取り扱い注意
- ログの定期削除
- 個人情報のマスキング

---

## 8. パフォーマンス要件

### 8.1 処理性能
- 100件バッチ処理: 60分以内
- 1件あたり処理時間: 平均30秒
- 同時実行: 最大5ユーザー

### 8.2 最適化戦略
- バッチサイズの動的調整
- API呼び出しの並列化
- キャッシュの活用

---

## 9. 拡張性考慮

### 9.1 将来拡張予定
- JV要件の自動判定
- AI による要件解釈の高度化
- Web アプリケーション化

### 9.2 設計原則
- SOLID原則の遵守
- モジュール間の疎結合
- インターフェースによる抽象化

---

## 10. 開発規約

### 10.1 コーディング規約
- ファイルサイズ: 最大500行
- 関数: 単一責任の原則
- 命名規則: camelCase

### 10.2 ドキュメント
- JSDoc形式でコメント記載
- 関数の入出力を明記
- エラーケースの説明

---

## 改訂履歴
- 2024-12-XX: 初版作成